import { createReducer, on } from '@ngrx/store';

import { ChatState, Companion, initialChatState, Item } from './chat-state.models';
import {
  createConversation,
  createConversationSuccess,
  createGroup,
  createGroupSuccess,
  deleteDialog,
  deleteDialogSuccess,
  deleteGroup,
  deleteGroupSuccess,
  errorMessage,
  getConversationList,
  getConversationListSuccess,
  getDialogfMessagesSuccess,
  getDialogMessages,
  getLastMessages,
  getLastMessagesSuccess,
  getListOfGroup,
  getListOfGroupSuccess,
  getListOfMessages,
  getListOfMessagesSuccess,
  getListOfPeople,
  getListOfPeopleSuccess,
  sendDialogMessages,
  sendDialogMessagesSuccess,
  sendMessages,
  sendMessagesSuccess,
  setSelectedGroup,
  setSelectedUser,
  updateDialogMessages,
  updateDialogMessagesSuccess,
} from './chat.actions';

export const chatReducer = createReducer<ChatState>(
  initialChatState,
  on(getListOfGroup, (state): ChatState => ({
    ...state,
    messageError: '',
    loading: true,
  })),
  on(getListOfGroupSuccess, (state, action): ChatState => ({
    ...state,
    messageError: '',
    grouplist: action.data,
    loaded: true,
    loading: false,
    isGrouplistLoaded: true,
  })),
  on(createGroup, (state, action): ChatState => ({
    ...state,
    messageError: '',
    loading: true,
    newName: action.name,
  })),
  on(createGroupSuccess, (state, action): ChatState => ({
    ...state,
    messageError: '',
    grouplist: {
      Items: [...[...state.grouplist?.Items || []], {
        id: { S: action.groupID },
        name: { S: state.newName },
        createdBy: { S: localStorage.getItem('uid') || '' },
        groupID: action.groupID,
      },
      ],
    },
    loaded: true,
    loading: false,
    isGrouplistLoaded: true,
  })),
  on(errorMessage, (state, action): ChatState => ({
    ...state,
    messageError: action.errorMessage,
    loaded: true,
    loading: false,
  })),
  on(deleteGroup, (state, action): ChatState => ({
    ...state,
    messageError: '',
    loading: true,
    grouplist: {
      Items: [...state.grouplist?.Items || []]
        .filter((group: Item) => group?.id?.S !== action.groupID),
    },
  })),
  on(deleteGroupSuccess, (state): ChatState => ({
    ...state,
    messageError: '',
    loaded: true,
    loading: false,
    isGrouplistLoaded: true,
  })),
  on(getListOfPeople, (state): ChatState => ({
    ...state,
    messageError: '',
    loading: true,
    loadingButton: true,
  })),
  on(getListOfPeopleSuccess, (state, action): ChatState => ({
    ...state,
    messageError: '',
    peoplelist: action.data,
    loaded: true,
    loading: false,
    isPeoplelistLoaded: true,
    loadingButton: false,
  })),
  on(getConversationList, (state): ChatState => ({
    ...state,
    messageError: '',
    loading: true,
    loadingButton: true,
  })),
  on(getConversationListSuccess, (state, action): ChatState => ({
    ...state,
    messageError: '',
    conversationlist: action.data,
    loaded: true,
    loading: false,
    isPeoplelistLoaded: true,
    isConversationsLoaded: true,
    loadingButton: false,
  })),
  on(createConversation, (state, action): ChatState => ({
    ...state,
    messageError: '',
    loading: true,
    conversationID: action.companion,
  })),
  on(createConversationSuccess, (state, { conversationID }): ChatState => ({
    ...state,
    messageError: '',
    conversationlist: {
      Items: [...[...state.conversationlist?.Items || []], {
        id: { S: state.conversationID },
        companionID: { S: conversationID },
        isLoadedDialog: true,
      },
      ],
    },
    loaded: true,
    loading: false,
    isGrouplistLoaded: true,
    isPeoplelistLoaded: true,
    isConversationsLoaded: true,
  })),
  on(setSelectedGroup, (state, action): ChatState => ({
    ...state,
    selectedGroup: action.groupID === state.groupID ? state.selectedGroup : undefined,
    groupID: action.groupID,
  })),
  on(getListOfMessages, (state, action): ChatState => ({
    ...state,
    messageError: '',
    loading: true,
    loadingButton: true,
    groupID: action.groupID,
  })),
  on(getListOfMessagesSuccess, (state, action): ChatState => ({
    ...state,
    messageError: '',
    selectedGroup: {
      ...state.selectedGroup,
      messagelist: action.data,
      isMessageListLoaded: true,
    },
    loaded: true,
    loading: false,
    isPeoplelistLoaded: true,
    isGrouplistLoaded: true,
    isConversationsLoaded: true,
    loadingButton: false,
  })),
  on(getLastMessages, (state, action): ChatState => ({
    ...state,
    messageError: '',
    loading: true,
    loadingButton: true,
    groupID: action.groupID,
    selectedGroup: {
      ...state.selectedGroup,
      since: action.since,
      isMessageListLoaded: true,
    },
  })),
  on(getLastMessagesSuccess, (state): ChatState => ({
    ...state,
    messageError: '',
    selectedGroup: {
      ...state.selectedGroup,
      isMessageListLoaded: true,
    },
    grouplist: {
      Items: [...[...state.grouplist?.Items || []], {
        isLoadedGroup: true,
      },
      ],
    },
    loaded: true,
    loading: false,
    isPeoplelistLoaded: true,
    isGrouplistLoaded: true,
    isConversationsLoaded: true,
    loadingButton: false,
  })),
  on(sendMessages, (state, action): ChatState => ({
    ...state,
    messageError: '',
    loading: true,
    groupID: action.groupID,
    selectedGroup: {
      ...state.selectedGroup,
      messagelist: {
        ...state.selectedGroup?.messagelist,
        Items: [...state.selectedGroup?.messagelist?.Items || [], {
          authorID: { S: localStorage.getItem('uid') || '' },
          message: { S: action.message },
          createdAt: { S: String(Date.now()) },
        }],
      },
    },
  })),
  on(sendMessagesSuccess, (state): ChatState => ({
    ...state,
    messageError: '',
    loaded: true,
    loading: false,
  })),
  on(deleteDialog, (state, action): ChatState => ({
    ...state,
    messageError: '',
    loading: true,
    conversationlist: {
      Items: [...state.conversationlist?.Items || []]
        .filter((person: Companion) => person?.id?.S !== action.conversationID),
    },
  })),
  on(deleteDialogSuccess, (state): ChatState => ({
    ...state,
    messageError: '',
    loaded: true,
    loading: false,
    isConversationsLoaded: true,
  })),
  on(sendDialogMessages, (state, action): ChatState => ({
    ...state,
    messageError: '',
    loading: true,
    conversationID: action.conversationID,
    selectedUser: {
      ...state.selectedUser,
      messagelist: {
        ...state.selectedUser?.messagelist,
        Items: [...state.selectedUser?.messagelist?.Items || [], {
          authorID: { S: localStorage.getItem('uid') || '' },
          message: { S: action.message },
          createdAt: { S: String(Date.now()) },
        }],
      },
    },
  })),
  on(sendDialogMessagesSuccess, (state): ChatState => ({
    ...state,
    messageError: '',
    loaded: true,
    loading: false,
  })),

  on(getDialogMessages, (state, action): ChatState => ({
    ...state,
    messageError: '',
    loading: true,
    loadingButton: true,
    conversationID: action.conversationID,
  })),
  on(getDialogfMessagesSuccess, (state, action): ChatState => ({
    ...state,
    messageError: '',
    selectedUser: {
      ...state.selectedUser,
      messagelist: action.data,
      isMessageListLoaded: true,
    },
    loaded: true,
    loading: false,
    isPeoplelistLoaded: true,
    isGrouplistLoaded: true,
    isConversationsLoaded: true,
    loadingButton: false,
  })),
  on(updateDialogMessages, (state, action): ChatState => ({
    ...state,
    messageError: '',
    loading: true,
    loadingButton: true,
    conversationID: action.conversationID,
    selectedUser: {
      ...state.selectedUser,
      since: action.since,
    },
  })),
  on(updateDialogMessagesSuccess, (state): ChatState => ({
    ...state,
    messageError: '',
    selectedUser: {
      ...state.selectedUser,
      isMessageListLoaded: true,
    },
    loaded: true,
    loading: false,
    isPeoplelistLoaded: true,
    isGrouplistLoaded: true,
    isConversationsLoaded: true,
    loadingButton: false,
  })),
  on(setSelectedUser, (state, action): ChatState => ({
    ...state,
    selectedUser: action.conversationID === state.conversationID ? state.selectedUser : undefined,
    conversationID: action.conversationID,
  })),
);
